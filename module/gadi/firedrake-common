if { [ info exists env(PBS_JOBFS) ] } {
    set tmpdir_base $::env(PBS_JOBFS)
    setenv PYTHONPYCACHEPREFIX $tmpdir_base
} elseif { [ info exists env(TMPDIR) ] } {
    set tmpdir_base $::env(TMPDIR)
} else {
    set tmpdir_base /tmp
}

if { [ info exists env(FIREDRAKE_USE_BUILD_OVERRIDE) ] } {
    set use_build $::env(FIREDRAKE_USE_BUILD_OVERRIDE)
} elseif { [ info exists env(PBS_ENVIRONMENT) ] } {
    set use_build ""
} else {
    set use_build "-inplace"
}
prepend-path PATH $prefix$use_build/$tag/venv/bin

setenv FIREDRAKE_BASE $prefix$use_build
setenv FIREDRAKE_TAG $tag
setenv VIRTUAL_ENV $prefix$use_build/$tag/venv


setenv PYOP2_CACHE_DIR $tmpdir_base/pyop2
setenv FIREDRAKE_TSFC_KERNEL_CACHE_DIR $tmpdir_base/tsfc
setenv XDG_CACHE_HOME $tmpdir_base/xdg

if { [ info exists env(MY_GADOPT) ] } {
    if { [ file exists $::env(MY_GADOPT)/gadopt/__init__.py ] } {
        prepend-path PYTHONPATH $::env(MY_GADOPT)
    } else {
        puts stderr "ERROR! gadopt/__init__.py not found at $::env(MY_GADOPT): please load g-adopt module"
    }
}

if { $use_build eq "" } {
    setenv FIREDRAKE_RUNTIME_TARGET_DIR $tmpdir_base
    prepend-path CONTAINER_OVERLAY_PATH $prefix/$tag.tar
    puts stderr "Distributing firedrake across all job nodes"
    puts stderr "This may take a while"
    if { [ module-info mode load ] } {
        exec mpirun /home/563/dr4292/distributor/distributor
    }
}